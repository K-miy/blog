---
title: "argparse: un outil méconnu"
author: "Stéphane Caron"
date: '2019-05-21'
slug: optparse-package
categories: ["R"]
type: post
description: "Utiliser le package argparse pour faciliter l'appel de scripts R."
output: html_document
featured: "argparse-package.png"
featuredpath: "img/headers/"
---



<p>Dans les derniers mois, j’ai été confronté à 2 défis qui m’ont éventuellement permis de découvrir un package R et une manière de programmer qui m’étaient auparavant inconnus. Dans un premier temps, je devais intégrer l’appel de programmes R à l’intérieur d’un <em>shell script</em> (un fichier avec l’extension <code>.sh</code>) dans lequel je devais passer différents arguments ou paramètres qui allaient être utilisés par le programme. Dans un deuxième temps, je devais lancer un programme R avec différents paramètres à l’intérieur d’une instance <em>Amazon Web Services (AWS)</em>, pour laquelle je n’avais pas d’interface graphique. Dans les deux cas, je devais faire l’appel d’un programme R à partir de la ligne de commande, ce que j’ai compris qui était possible avec la commande <code>Rscript</code>, mais pour lequel je devais également passer des arguments à ce programme lors de l’appel. C’est à ce moment que j’ai fais la découverte du package <a href="https://cran.r-project.org/web/packages/argparse/index.html">argparse</a>, un outil méconnu par plusieurs et qui offre des fonctionnalités intéressantes.</p>
<div id="argparse-et-la-ligne-de-commande" class="section level1">
<h1><code>argparse</code> et la ligne de commande</h1>
<p>Comme vous l’avez probablement deviné dans l’introduction, <code>argparse</code> est un package R qui permet de facilter l’appel de programmes R à partir de la ligne de commande. Pour être plus précis, <code>argparse</code> est un package qui permet de créer une interface de ligne de commande (ou <em>command line interface</em> ou <em>CLI</em>). Cette interface agit en quelque sorte de pont (ou moyen de communication) entre l’appel d’une commande via le terminal et les opérations effectuées à l’intérieur d’un programme.</p>
<p>Pourquoi appeler un programme R de la ligne de commande alors qu’on peut le lancer directement de la majorité des <em>IDE</em> comme RStudio ou même à partir de R directement? Il y a plusieurs exemples qui pourraient être cités, les deux exemples mentionnés en introduction sont pour moi des applications courantes, surtout lorsqu’on doit utiliser des ressources en ligne comme des instances <em>AWS</em> pour plus de puissance de calculs. Ces instances sont souvent dépourvues d’interface graphique, ce qui fait en sorte que nous nous retrouvons souvent devant le terrifant écran noir du terminal.</p>
</div>
<div id="fonctionnement" class="section level1">
<h1>Fonctionnement</h1>
<p>Le package R <code>argparse</code> est très similaire à la librarie Python du même nom. De plus, il existe d’autres packages R, comme <a href="https://cran.r-project.org/web/packages/optparse/index.html">optparse</a>, qui fonctionnent de manière similaire. L’objectif de cet article n’est pas de vanter un package plus d’un autre, mais plutôt d’illustrer le concept général en utilisant comme exemple le package <code>argparse</code>. La création d’une interface de ligne de commande avec ce package est très simple, les étapes sont généralement:</p>
<ol style="list-style-type: decimal">
<li>Définir les arguments pouvant être appelés de la ligne de commande</li>
<li>Parser les arguments et les stockés dans un objet (habituellement une liste)</li>
<li>Utiliser les éléments ce cette liste dans le programme</li>
</ol>
<p>Les étapes 2 et 3 sont sont assez simples à réaliser. L’étape la plus cruciale est de bien définir les arguments (étape 1). Pour se faire, il y a quelques considérations à prendre en compte. Les prochaines sections vont permettre de mieux définir ces considérations.</p>
<div id="initialiser-lobjet-parser" class="section level2">
<h2>Initialiser l’objet <code>Parser</code></h2>
<p>Tout d’abord, avant même de définir les arguments, il faut attacher le package <code>argparse</code> et initialiser l’objet de type <code>Parser</code>. Nous pourrons ensuite ajouter des arguments à cet objets dans les prochaines sections.</p>
<pre class="r"><code>library(argparse)
parser &lt;- ArgumentParser(description = &quot;Simuler des distributions normales&quot;)</code></pre>
</div>
<div id="nommer-les-arguments" class="section level2">
<h2>Nommer les arguments</h2>
<p>Maintenant que l’objet <code>Parser</code> est définit, il faut définir et nommer les arguments qui pourront être appelés à la ligne de commande. Pour ajouter ces arguments à notre objet, on utilise la méthode <code>add_argument()</code>. Il existe deux sortes d’arguments: les argument positionnels et les arguments optionnels. Dans le premier cas, ces arguments sont obligatoires et doivent être appelés dans un ordre précis alors que dans le deuxième cas, ils sont facultatifs et peuvent être appelés dans n’importe quel ordre, tant qu’ils sont nommés dans l’appel. Voici un exemple simple d’ajout de ces 2 sortes d’arguments:</p>
<pre class="r"><code>parser$add_argument(&quot;n_dist&quot;, type = &quot;integer&quot;)
parser$add_argument(&quot;-m&quot;, &quot;--mean&quot;, type = &quot;double&quot;, default = 0)</code></pre>
<p>Les arguments optionnels sont généralement identifiés par le préfixe <code>-</code> alors que les autres seront considérés comme positionnels. L’option <code>required</code> permet également de spécifier les arguments qui ne peuvent être omis lors de l’appel.</p>
<p>Il est possible de spécifier le type de valeur de l’argument grâce à l’option <code>type</code> qui peut prendre les types suivants:</p>
<ul>
<li>“double”</li>
<li>“character”</li>
<li>“logical”</li>
<li>“integer”</li>
</ul>
<p>Les arguments optionnels doivent être accompagnés par une valeur par défaut. Notez que les arguments optionnels sont parfois nommés de 2 manières, avec un seul trait d’union (<code>-m</code>) pour l’abréviation courte et deux (<code>--mean</code>) pour le nom complet. Il n’est pas obligatoire de mettre les deux, mais cela peut améliorer la clarté de l’appel.</p>
</div>
<div id="definir-laide" class="section level2">
<h2>Définir l’aide</h2>
<p>Une fonctionnalité intéressante avec les interfaces de ligne de commande comme celle du package <code>argparse</code> est que l’on peut généralement définir une aide pour l’appel pour chaque argument pouvant être appelé par le programme. Cette aide peut être affichée en appelant l’argument <code>-h</code> ou <code>--help</code> au programme. Par exemple,</p>
<pre class="r"><code>parser &lt;- ArgumentParser(description = &quot;Simuler des distributions normales&quot;)
parser$add_argument(&quot;n_dist&quot;, type = &quot;integer&quot;,
                    help = &quot;nombre de distributions simulées&quot;)
parser$add_argument(&quot;-m&quot;, &quot;--mean&quot;, type = &quot;double&quot;, default = 0,
                    help = &quot;moyenne pour chaque distribution normale [défault: %(default)s]&quot;)
parser$print_help()</code></pre>
<pre><code>## usage: /Library/Frameworks/R.framework/Versions/3.5/Resources/library/blogdown/scripts/render_page.R
##        [-h] [-m MEAN] n_dist
## 
## Simuler des distributions normales
## 
## positional arguments:
##   n_dist                nombre de distributions simulées
## 
## optional arguments:
##   -h, --help            show this help message and exit
##   -m MEAN, --mean MEAN  moyenne pour chaque distribution normale [défault: 0]</code></pre>
<p>Notez que la valeur par défaut peut être incorporée dans l’aide (voir le code ci-dessus).</p>
</div>
<div id="fonctionnalites-supplementaires" class="section level2">
<h2>Fonctionnalités supplémentaires</h2>
<p>Ces quelques options devraient vous permettre de créer une interface de ligne de commande simple d’utilisation et couvrant la majorité de vos besoins. Toutefois, notez que le package possède également plusieurs autres fonctionnalités intéressantes comme regrouper des arguments, hériter des proprités de d’autres arguments parents, améliorer l’affichage de l’aide, etc.</p>
</div>
<div id="une-fois-les-arguments-definits" class="section level2">
<h2>Une fois les arguments définits</h2>
<p>Une fois les arguments bien définis, il ne reste plus qu’à <em>parser</em> les arguments passés à ligne de commande et les utiliser dans le programme en utilisant la fonction <code>parse_args()</code>:</p>
<pre class="r"><code>args &lt;- parser$parse_args()</code></pre>
</div>
</div>
<div id="exemple" class="section level1">
<h1>Exemple</h1>
<p>Voici un exmple de programme où est-ce qu’on veut simuler un certain nombre de lois normales et estimer la moyenne et l’écart-types de la distribution selon ces simulations. De plus, nous voulons avoir la possibilité de définir les paramètres de ces lois normales et aussi l’option de sauvergarder un graphique illustrant la densité estimée comparativement à la vraie densité.</p>
<pre class="r"><code>library(argparse)
library(ggplot2)


# Batir l’interface de ligne de commande ----------------------------------

parser &lt;- ArgumentParser(description = &quot;Simuler des distributions normales&quot;)
parser$add_argument(&quot;n_dist&quot;, type = &quot;integer&quot;,
                    help = &quot;nombre de distributions à simuler&quot;)
parser$add_argument(&quot;-m&quot;, &quot;--mean&quot;, type = &quot;double&quot;, default = 0, metavar = &quot;&quot;,
                    help = &quot;moyenne pour chaque distribution normale [défault: %(default)s]&quot;)
parser$add_argument(&quot;-s&quot;, &quot;--sd&quot;, type = &quot;double&quot;, default = 1, metavar = &quot;&quot;,
                    help = &quot;écart-type pour chaque distribution normale [défault: %(default)s]&quot;)
parser$add_argument(&quot;-n&quot;, &quot;--n-obs&quot;, type = &quot;integer&quot;, default = 1000, metavar = &quot;&quot;,
                    help = &quot;nombre d&#39;observations simulés dans chaque simulation [défault: %(default)s]&quot;)
parser$add_argument(&quot;-r&quot;, &quot;--random-seed&quot;, type = &quot;integer&quot;, default = 42, metavar = &quot;&quot;,
                    help = &quot;nombre aléatoire d&#39;amorce [défault: %(default)s]&quot;)
parser$add_argument(&quot;-g&quot;, &quot;--graph-save&quot;, action = &quot;store_true&quot;, 
                    help = &quot;sauvegarder le graphique [défault: %(default)s]&quot;)
parser$add_argument(&quot;-p&quot;, &quot;--path-graph&quot;, type = &quot;character&quot;, default = &quot;./graph.png&quot;, metavar = &quot;&quot;,
                    help = &quot;chemin vers lequel sauvegarder le graphique [défault: \&quot;%(default)s\&quot;]&quot;)

args &lt;- parser$parse_args()


# Simuler les lois normales -----------------------------------------------

set.seed(args$random_seed)

simulated_list &lt;- lapply(1:args$n_dist, function(x) sort(rnorm(n = args$n_obs, mean = args$mean, sd = args$sd)))
simulated_matrix &lt;- matrix(unlist(simulated_list), nrow = args$n_dist, ncol = args$n_obs, byrow = TRUE)
mean_distribution &lt;- colMeans(simulated_matrix)

# Imprimer la moyenne et l&#39;ecart type estimés
mean(mean_distribution)
sd(mean_distribution)

# Faire le graphique de la distribution simulée
plot &lt;- ggplot(data.frame(obs = mean_distribution), aes(obs)) +
  geom_histogram(aes(y = ..density.., color = &quot;Simulated&quot;), 
                 bins = 30) +
  stat_function(fun=function(x)dnorm(x, mean = args$mean, sd = args$sd),
                size = 2, aes(color = &quot;True&quot;)) + 
  scale_y_continuous(&quot;Density&quot;) +
  scale_x_continuous(&quot;x&quot;) +
  scale_colour_manual(&quot;Distribution&quot;, values = c(&quot;gray&quot;, &quot;red&quot;)) + 
  theme_classic()

# Sauvegarder le graphique
if (args$graph_save) {
  ggsave(args$path_graph, plot) 
}</code></pre>
</div>
<div id="conclusion" class="section level1">
<h1>Conclusion</h1>
<p>Pour davantage d’informations sur le fonctionnement du package ou et des différentes options, vous pouvez consulter de <a href="https://github.com/trevorld/r-argparse">dépôt</a> du package R et aussi la documentation complète <a href="https://docs.python.org/3/library/argparse.html">en ligne</a> de la même librarie Python. J’espère que ce court article vous aura permis de maîtriser l’essentiel quant au fonctionnement des interfaces de ligne de commande et leur utilité.</p>
</div>
